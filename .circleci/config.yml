version: 2.1
orbs:
  win: circleci/windows@5.0
  advanced-checkout: vsco/advanced-checkout@1.1.0
jobs:
  Checkout:
    executor: win/server-2022
    steps:
      - advanced-checkout/shallow-checkout:
          fetch_lfs: true
          fetch_submodules: true

  Dependencies:
    executor: win/server-2022
    steps:
      - run: python $CIRCLE_WORKING_DIRECTORY/Scripts/make.py --checkout

  Patch:
    executor: win/server-2022
    steps:
      - run: python $CIRCLE_WORKING_DIRECTORY/Scripts/make.py --patch

  Premake:
    executor: win/server-2022
    steps:
      - run: python $CIRCLE_WORKING_DIRECTORY/Scripts/make.py --premake

  Qt:
    executor: win/server-2022
    steps:
      - run: python $CIRCLE_WORKING_DIRECTORY/Scripts/make.py --aqt=6.5.3

  Build:
    executor: win/server-2022
    steps:
      - run: python $CIRCLE_WORKING_DIRECTORY/Scripts/make.py --aqt=6.5.3 --build

workflows:
  Nightly:
    jobs:
      - Checkout
      - Qt:
          requires:
            - Checkout
      - Dependencies:
          requires:
            - Qt
      - Patch:
          requires:
            - Dependencies
      - Premake:
          requires:
            - Patch
      - Build:
          requires:
            - Premake